(function($) {
	$.fn.autocomplete=function(options){
		if ($(this).is('input:text')) {
			options = jQuery.extend({
				 minChars: 2,
			     maxItemsToShow: 10,
			     delay: 400,
			     divid: '',//数据显示层ID
			     flagid: '',//控制开关ID
			     url:''
	    	}, options);
		}
		
		$.Autocompleter = function($elem, options) {
	        this.options = options;
	        var self = this;
	        this.keyTimeout_ = null;
	        this.dom = {};
	        this.dom.$elem = $elem;
	        this.dom.$elem.attr('autocomplete', 'off');

	        $elem.blur(function() {
	        	setTimeout(function() { $('#'+options.divid).hide();}, 200);
	        });
	        
	        $elem.keydown(function(e) {
	            switch(e.keyCode) {
	                case 38:
	                case 39:
	                case 40:
	                case 9: 
	                case 13:
	                case 27: 
	                	break;
	                default:
	                    self.activate();
	                	break;
	            }
	        });
		};
		/**
	     * Set timeout to activate autocompleter
	     */
	    $.Autocompleter.prototype.activate = function() {
	    	if (this.options.flagid != '' && $('#'+this.options.flagid).attr('class') != 'current') {
	    		if (this.keyTimeout_) {
		            clearTimeout(this.keyTimeout_);
		        }
	    		return;
	    	}
	        var self = this;
	        var activateNow = function() {
	            self.activateNow();
	        };
	        var delay = parseInt(this.options.delay, 10);
	        if (isNaN(delay) || delay <= 0) {
	            delay = 250;
	        }
	        if (this.keyTimeout_) {
	            clearTimeout(this.keyTimeout_);
	        }
	        this.keyTimeout_ = setTimeout(activateNow, delay);
	    };
	    $.Autocompleter.prototype.activateNow = function() {
	        var value = this.dom.$elem.val();
	        if (value.length >= this.options.minChars) {
                this.fetchData(value);
            }
	    };
	    $.Autocompleter.prototype.fetchData = function(value) {
	    	var element = this.dom.$elem;
	    	if (this.options.url != '') {
		    	$.ajax({
		    		type:'post',
	                url: this.options.url,
	                data:{'condition':value,'size':this.options.maxItemsToShow},
	                success: function(data) {
	                	if (data.no == 0 && data.data.size > 0) {
	                		var divOjb = $('#'+options.divid);
	                		var ulObj = $('ul',divOjb);
	                		ulObj.html('');
		                	$.each(data.data.result, function() {
		                		var html = '';
		                		var newLi = jQuery(document.createElement("li"));
		                		var newHref = jQuery(document.createElement("a"));
		                		newHref.attr('href','javascript:void(0)');
		                		newHref.text(this.keyword);
		                		newHref.click(function(){
		                			element.val($(this).text());
		                			element.focus();
		                			divOjb.hide();
		                			OPPO.help.search.submit('condition');
		                		});
		                		newLi.append(newHref);
		                		ulObj.append(newLi);
		                	});
	                		divOjb.slideDown();
	                	}
		            },
	                error: function() {
	                    
	                },
	                dataType: 'json'
	            });
	    	}
	    };
	    
	    new $.Autocompleter($(this), options);
	};
})(jQuery);

